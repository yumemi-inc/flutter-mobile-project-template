# プルリクエストの運用方針について

## 背景

開発プロジェクトにおいて、以下のような問題が発生していました。

- プルリクエストレビュー後にリベース & 強制 PUSH を行うことで、レビュアーがすべてのコミットを再度確認する必要がある。
- 1 つのコミットで複数のレビューコメントへの対応が含まれていると、レビュアーの確認が困難になる。

これにより、レビュー効率の低下・見落としのリスクが高まる課題がありました。

## 目的

本方針では

- レビュアーと開発者の **双方が効率的にレビューを行えるようにする** ことを目的としています。
- プロジェクトのコード **品質維持** と **チーム全体の開発効率向上** を目的としています。

## 基本方針

プロジェクトの性質により細かい対応は異なりますが、以下の方針を原則とします。

### 1. リベース & 強制 PUSH の禁止

- プルリクエスト作成後、レビューが入った時点での `rebase` および `force-push` は原則禁止とします。
- 代替手段として、**マージコミット**や**新規コミットの追加**による対応を推奨します。

### 2. コミットの分割

- レビュー対応時は、**1 つのコメントにつき 1 コミット**を原則とします。
- 対応内容を明示的にし、レビューや差分確認を簡潔にすることを目的とします。

## 運用例

### 想定フロー

1. プルリクエスト作成
2. レビューコメントが入る
3. 各コメントに対して個別にコミットを追加
4. 全体の対応が完了したらレビュアーに再確認依頼
5. 問題なければマージ（Squash / Merge モードなどプロジェクトポリシーに準拠）

> [!IMPORTANT]
>
> - **レビュー済の内容を force-push により破棄しない**
> - **レビュアーの確認負荷を最小化するために commit 単位での整理を行う**

## リベース検出の自動化

プロジェクトでは、PR の rebase や force-push を検出する自動チェックが実装されています。

### 検出の仕組み

[**`.guthub/workflows/pr-rebaes-detector.yaml`**](../.github/workflows/pr-rebase-detector.yaml) を利用して以下を自動的にチェックしています：

1. PR が更新（synchronize イベント）されたとき
2. Git の履歴が非線形（rebase や force-push の可能性）かどうか
3. 非線形履歴が検出された場合、PR にコメントで警告

> [!NOTE]
> 目的：
>
> - レビュアーの負荷軽減
> - チーム全体での運用ルールの徹底
> - 開発者への教育・意識付け

### 警告が表示された場合の対応

PR に rebase 検出の警告が表示された場合は、以下を検討してください：

1. 今後の修正は個別コミットとして追加する
2. 必要な変更があれば、マージコミットを利用する
3. やむを得ず rebase が必要な場合は、事前にレビュアーと相談する

> [!NOTE]
> このチェックは強制ではなく、あくまでチーム全体の効率化のための仕組みです。

## 補足

- 大きなリファクタ等で複数の指摘を同時に修正する場合は、レビュアーと事前に相談のうえ例外的な合意をとることは可とします。
- チームの Git 運用方針に合わせて調整してください。
